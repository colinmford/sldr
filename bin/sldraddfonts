#!/usr/bin/python3

from langtag import lookup  # , langtag
from palaso.sldr.ldml import Ldml, iterate_files
import cssutils
import csv
import os
import os.path
import argparse

script2suggestions = dict()
css2suggestions = dict()
css2features = dict()
css_locales = set()


def main():
    parser = argparse.ArgumentParser(description='Populate font information to LDML files')
    parser.add_argument("sldr", help="root of SLDR tree to write into")
    parser.add_argument('datafile', help='CSV file export from Google Sheet document Script2Font')
    parser.add_argument('stylesheet', help='CSS stylesheet with user settable font features')
    parser.add_argument('--version', action='version', version='%(prog)s: 0.1')
    args = parser.parse_args()

    read_font_data(args.datafile)
    read_feature_data(args.stylesheet)
    write_font_data(args.sldr)


def read_font_data(data_file_name):
    """Read CSV data file"""
    font_sources = ('WSTech primary', 'NLCI', 'Other', 'Noto Sans', 'Noto Serif', 'WSTech secondary')
    with open(data_file_name, 'r', newline='') as data_file:
        reader = csv.DictReader(data_file)
        for row in reader:
            # Construct font tag
            script = row['Code']
            ft = script
            for region in row['Region'].split(', '):
                if region != '':
                    ft = script + '-' + region

                # Assemble list of fonts for the font tag
                fonts = list()
                for font_source in font_sources:
                    preferred_fonts = row[font_source]
                    if preferred_fonts:
                        for preferred_font in preferred_fonts.split(', '):
                            fonts.append(preferred_font)
                if len(fonts) > 0:
                    script2suggestions[ft] = fonts


def read_feature_data(stylesheet_file_name):
    """Read CSS stylesheet for user font features"""

    # Microsoft fonts are not OFL so are not added to the SLDR
    ignore_fonts = ['Times New Roman', 'Arial', 'Arial Black', 'Calibri', 'Cambria',
                    'Tahoma', 'Verdana', 'Microsoft Himalaya', 'Angsana New']

    # Other fonts are virtual fonts and also do not need to be in the SLDR
    ignore_fonts.append('serif')

    sheet = cssutils.parseFile(stylesheet_file_name)
    for rule in sheet:
        if rule.type == rule.STYLE_RULE:
            # find full locale
            locale = rule.selectorText[len(':lang('):-1]
            try:
                ts = lookup(locale, matchRegions=True, use639=True)
                css_locales.add(str(ts.tag))
            except KeyError:
                pass

            # find fonts and maybe features
            message = locale + ': '
            for prop in rule.style:
                if prop.name == 'font-family':
                    message += prop.name + prop.value
                    fonts = list()
                    preferred_fonts = prop.value.replace('"', '')
                    for preferred_font in preferred_fonts.split(', '):
                        if preferred_font in ignore_fonts:
                            continue
                        fonts.append(preferred_font)
                    if len(fonts) > 0:
                        css2suggestions[locale] = fonts
                if prop.name == 'font-feature-settings':
                    message += prop.name + prop.value
                    features = list()
                    specified_features = prop.value
                    for css_specified_feature in specified_features.split(', '):
                        ldml_specified_feature = css_specified_feature.replace(' ', '=').replace('"', '')
                        features.append(ldml_specified_feature)
                    if len(features) > 0:
                        css2features[locale] = features
            # print(message)


def find_fonts_from_csv(locale):
    """Return a list of preferred fonts from the CSV file"""
    # Find script and possibly region
    region = None
    try:
        ts = lookup(locale, matchRegions=True, use639=True)
        script = ts.script
        region = ts.region
    except KeyError:
        print(f'Cannot find locale {locale}, using fallback')
        return ['Charis SIL']

    # Find font from table
    ft = script
    if region:
        ft = script + '-' + region
    if ft in script2suggestions:
        return script2suggestions[ft]
    elif script in script2suggestions:
        return script2suggestions[script]
    return ['Charis SIL']


def find_fonts_from_css(locale):
    """Return a list of preferred fonts from the CSS file"""
    if locale in css2suggestions:
        return css2suggestions[locale]
    else:
        return []


def find_ldml_files(sldrtree):
    """Find LDML files in the SLDR"""
    for filepath in iterate_files(sldrtree):
        # Find preferred font
        xml_locale = os.path.splitext(os.path.basename(filepath))[0].replace('_', '-')
        yield xml_locale, filepath


def process_font(fonts, all_fonts, label=''):
    """Add preferred fonts to a list to add to the SLDR"""
    message = ''
    if len(fonts) > 0:
        message += f' {label}: '
        for font in fonts:
            message += '-' + font
            all_fonts.append(font)
    return message


def write_font_data(sldrtree):
    """Write preferred font information to SLDR"""

    # Find locales specified in CSS that are not in the SLDR
    xml_locales = set()
    for xml_locale, filepath in find_ldml_files(sldrtree):
        try:
            ts = lookup(xml_locale, matchRegions=True, use639=True)
            xml_locales.add(str(ts.tag))
        except KeyError:
            pass

    for locale in css_locales - xml_locales:
        pass
        # print(f'{locale}: only in css')
    # No need to add the three locales found that are only in the CSS file
    # to LDML files (with just font info)
    # since their font is the same as the fallback script font.

    # Find locales specified in CSS that have font features
    for locale in css2features:
        message = ''
        for feature in css2features[locale]:
            message += '-' + feature + ': '
        if locale in css2suggestions:
            for preferred_font in css2suggestions[locale]:
                message += '-' + preferred_font
        else:
            message += '-no font'
        # print(f'{locale}::: {message}')

    # Update SLDR with better font information
    for xml_locale, filepath in find_ldml_files(sldrtree):
        all_preferred_fonts = list()

        # Find preferred fonts (which might be specified in the CSS file)
        preferred_fonts_from_csv = find_fonts_from_csv(xml_locale)
        preferred_fonts_from_css = find_fonts_from_css(xml_locale)

        only_csv = sorted(set(preferred_fonts_from_csv) - set(preferred_fonts_from_css))
        only_css = sorted(set(preferred_fonts_from_css) - set(preferred_fonts_from_csv))

        common_preferred_fonts = set(preferred_fonts_from_csv) & set(preferred_fonts_from_css)

        message = ''
        message += process_font(common_preferred_fonts, all_preferred_fonts, 'common')
        message += process_font(only_csv, all_preferred_fonts, 'only in csv')
        message += process_font(only_css, all_preferred_fonts, 'only in css')
        # if len(common_preferred_fonts) > 0:
        #     message += ' common: '
        #     for preferred_font in common_preferred_fonts:
        #         message += '-' + preferred_font
        #         all_preferred_fonts.append(preferred_font)
        # if len(only_csv) > 0:
        #     message += ' only in csv:'
        #     for preferred_font in only_csv:
        #         message += '-' + preferred_font
        #         all_preferred_fonts.append(preferred_font)
        # if len(only_css) > 0:
        #     message += ' only in css:'
        #     for preferred_font in only_css:
        #         message += '-' + preferred_font
        #         all_preferred_fonts.append(preferred_font)
        message += ' feat(s):'
        if xml_locale in css2features:
            for feature in css2features[xml_locale]:
                message += '-' + feature
        print(f'{xml_locale}::{message}')

        # Write preferred font to LDML file
        default = '[@types="default"]'
        for preferred_font in all_preferred_fonts:
            ldml = Ldml(filepath)
            resource = ldml.ensure_path(f'special/sil:external-resources/sil:font[@name="{preferred_font}"]{default}/sil:url')[0]
            resource.text = 'https://wirl.api.sil.org/' + preferred_font.replace(' ', '')
            ldml.save_as(filepath, topns=True)
            default = ''  # only the first font is the default font


if __name__ == '__main__':
    main()
